Sub D4C()

    Dim wsD4C As Worksheet, wsAmtTermSID As Worksheet, wsNonPymt As Worksheet
    Dim lastRow As Long

    ' Set worksheet references
    Set wsD4C = ThisWorkbook.Sheets("D4C")
    Set wsAmtTermSID = ThisWorkbook.Sheets("AmtTermSID")
    Set wsNonPymt = ThisWorkbook.Sheets("NonPymt")
    
    ' Step 1: Auto unmerge and autofit height and width for all sheets
    Dim ws As Worksheet
    For Each ws In ThisWorkbook.Sheets
        ws.Cells.UnMerge
        ws.Cells.EntireColumn.AutoFit
        ws.Cells.EntireRow.AutoFit
    Next ws

    ' Step 2: Clear the D4C sheet to prepare for new data
    wsD4C.Cells.ClearContents

    ' Step 3: Copy data from AmtTermSID (starting from row 8 to exclude headers)
    With wsAmtTermSID
        lastRow = .Cells(.Rows.Count, "C").End(xlUp).Row ' Find the last row with data in Column C
        .Range("C8:D" & lastRow).Copy ' Skip rows 1-7
    End With
    wsD4C.Range("A2").PasteSpecial Paste:=xlPasteValues ' Paste values into D4C starting at row 2

    ' Step 4: Remove any blank rows in D4C (Columns A and B)
    lastRow = wsD4C.Cells(wsD4C.Rows.Count, "A").End(xlUp).Row ' Find the last row in Column A
    Dim i As Long
    For i = lastRow To 2 Step -1
        If wsD4C.Cells(i, "A").Value = "" And wsD4C.Cells(i, "B").Value = "" Then
            wsD4C.Rows(i).Delete
        End If
    Next i

    ' Step 5: Add VLOOKUP formula for "Phone No." in Column C
    lastRow = wsD4C.Cells(wsD4C.Rows.Count, "A").End(xlUp).Row ' Recalculate last row in Column A
    wsD4C.Range("C2:C" & lastRow).Formula = "=IFERROR(VLOOKUP(A2,NonPymt!D:E,2,FALSE),""Number Not Listed"")"

    ' Step 6: Add VLOOKUP formula for "NonPayment" in Column D
    wsD4C.Range("D2:D" & lastRow).Formula = "=VLOOKUP(A2,NonPymt!D:N,11,FALSE)"

    ' Step 7: Delete Row 1 and shift rows up
    wsD4C.Rows(1).Delete

    ' Step 8: Copy C1 and D1 and paste as values
    wsD4C.Range("C1").Value = wsD4C.Range("C1").Value ' Paste C1 as value
    wsD4C.Range("D1").Value = wsD4C.Range("D1").Value ' Paste D1 as value

    ' Step 9: Enable filtering for all rows
    lastRow = wsD4C.Cells(wsD4C.Rows.Count, "A").End(xlUp).Row ' Recalculate last row in Column A
    wsD4C.Rows(1).AutoFilter

    ' Autofit height and width for the D4C sheet
    wsD4C.Cells.EntireColumn.AutoFit
    wsD4C.Cells.EntireRow.AutoFit

    MsgBox "Macro completed successfully!", vbInformation

End Sub
