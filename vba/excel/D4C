Sub D4C()

    Dim wsD4C As Worksheet, wsAmtTermSID As Worksheet, wsNonPymt As Worksheet
    Dim lastRow As Long
    Dim dataRange As Range

    ' Set worksheet references
    Set wsD4C = ThisWorkbook.Sheets("D4C")
    Set wsAmtTermSID = ThisWorkbook.Sheets("AmtTermSID")
    Set wsNonPymt = ThisWorkbook.Sheets("NonPymt")
    
    ' Step 1: Auto unmerge and autofit height and width for all sheets
    Dim ws As Worksheet
    For Each ws In ThisWorkbook.Sheets
        ws.Cells.UnMerge
        ws.Cells.EntireColumn.AutoFit
        ws.Cells.EntireRow.AutoFit
    Next ws

    ' Step 2: Clear the D4C sheet to prepare for new data
    wsD4C.Cells.ClearContents

    ' Step 3: Add headers to D4C sheet
    wsD4C.Range("A1").Value = "ID"
    wsD4C.Range("B1").Value = "Name"
    wsD4C.Range("C1").Value = "Phone No."
    wsD4C.Range("D1").Value = "NonPayment"

    ' Format headers
    wsD4C.Rows(1).Font.Bold = True

    ' Step 4: Copy data from AmtTermSID (starting from row 8 to exclude headers)
    With wsAmtTermSID
        lastRow = .Cells(.Rows.Count, "C").End(xlUp).Row ' Find the last row with data in Column C
        Set dataRange = .Range("C8:D" & lastRow) ' Explicitly skip rows 1-7
        dataRange.Copy
    End With
    wsD4C.Range("A2").PasteSpecial Paste:=xlPasteValues ' Paste values into D4C starting at row 2

    ' Step 5: Remove any blank rows in D4C (Columns A and B)
    lastRow = wsD4C.Cells(wsD4C.Rows.Count, "A").End(xlUp).Row ' Find the last row in Column A
    Dim i As Long
    For i = lastRow To 2 Step -1
        If wsD4C.Cells(i, "A").Value = "" And wsD4C.Cells(i, "B").Value = "" Then
            wsD4C.Rows(i).Delete
        End If
    Next i

    ' Step 6: Add VLOOKUP formula for "Phone No." in Column C
    lastRow = wsD4C.Cells(wsD4C.Rows.Count, "A").End(xlUp).Row ' Recalculate last row in Column A
    wsD4C.Range("C2:C" & lastRow).Formula = "=IFERROR(VLOOKUP(A2,NonPymt!D:E,2,FALSE),""Number Not Listed"")"

    ' Step 7: Add VLOOKUP formula for "NonPayment" in Column D
    wsD4C.Range("D2:D" & lastRow).Formula = "=VLOOKUP(A2,NonPymt!D:N,11,FALSE)"
    
    ' Autofit height and width for the D4C sheet
    wsD4C.Cells.EntireColumn.AutoFit
    wsD4C.Cells.EntireRow.AutoFit

    MsgBox "Macro completed successfully!", vbInformation

End Sub
